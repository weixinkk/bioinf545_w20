---
title: "Comparisons of Differential Expression Tools on Different Data Sources"
output: html_notebook
---

# Setup
```{r}
library(biomaRt)
library(DESeq2)
library(sleuth)
library(tximport)
library(jsonlite)
library(tidyverse)
set.seed(42)
```

## Setup sample details
```{r}
# Load in samples and point to kallisto paths
samples <- read_tsv("../work/input/sample_manifest.tsv")
samples$kallisto_path <- file.path("..","work","intermediate","quant",samples$SRR)
```

## Transcript <-> Gene Mappings
```{r}
mart <- biomaRt::useMart(biomart = "ENSEMBL_MART_ENSEMBL",
  dataset = "hsapiens_gene_ensembl",
  host = 'grch37.ensembl.org')
t2g <- biomaRt::getBM(attributes = c("ensembl_transcript_id_version", "ensembl_gene_id",
    "external_gene_name"), mart = mart)
```

## QC Filtering
We'll filter high quality samples by percent reads mapped by Kallisto. We'll need to get hte total reads in files from the kallisto logs, and the total number of mapped reads by pre-loading all the counts using sleuth. 
```{r}
# Find total reads to compute percent mapped
samples$n_reads <- apply(samples,1,function(x)read_json(file.path(x["kallisto_path"],"run_info.json"))$n_processed)
```

```{r}
# Initial sleuth just to get kallisto counts
s_obj_counts <- sleuth_prep(
  sample_to_covariates = rename(samples,path=kallisto_path,sample=SRR),
  normalize=FALSE
)
```

```{r}
kallisto_est_mapped <- s_obj_counts$obs_raw %>%
  group_by(sample) %>%
  summarise(kallisto_mapped_reads=sum(est_counts))
samples <- samples %>% 
  left_join(kallisto_est_mapped,by=c("SRR"="sample")) %>%
  mutate(percent_mapped=kallisto_mapped_reads/n_reads) 
samples %>%
  ggplot(aes(x = percent_mapped)) +
    geom_histogram(bins = 5) +
    labs(title = "Distribution of % Mapped Reads", x = "% Mapped Reads")
```

```{r}
# Filter samples
samples_filt <-samples %>% 
  filter(percent_mapped > 0.8)
```



# Sleuth


```{r include=FALSE}
# Setup sleuth object
s_obj <- sleuth_prep(
  sample_to_covariates = rename(samples_filt,path=kallisto_path,sample=SRR),
  full_model = ~Response,
  transform_fun_counts=function(x)log2(x+1),
  target_mapping = rename(t2g,target_id=ensembl_transcript_id_version),
  aggregation_column = "external_gene_name",
  gene_mode=TRUE
)
```
## QC

```{r}
plot_mean_var(s_obj) +
  labs(title="Mean Variance Relationship")
```


## PCA 

### Sleuth default
```{r}
plot_pca(s_obj,units="scaled_reads_per_base",color_by = "Response")
```

### Standardized PCA
```{r}
sleuth_rna_norm <- s_obj$obs_norm_filt %>% 
  select(sample,target_id,scaled_reads_per_base) %>%
  spread(key=target_id,value=scaled_reads_per_base) %>%
  column_to_rownames("sample")
#sleuth_rna_norm_std <- scale(sleuth_rna_norm)
sleuth_std_pca <- prcomp(sleuth_rna_norm,center=TRUE,scale.=TRUE)
sleuth_std_pca$x[,1:2] %>%
  as.data.frame() %>%
  rownames_to_column("SRR") %>%
  left_join(samples,by="SRR") %>%
  ggplot(aes(x=PC1,y=PC2,color=Response,label=SRR)) +
    geom_point() 
   # geom_label(size=2)
```

## Diffex

### LRT
```{r}
s_obj <- s_obj %>%
  sleuth_fit(~Response,"full") %>%
  sleuth_fit(~1,"reduced") %>%
  sleuth_lrt("reduced","full")
```
```{r}
sleuth_diffex_lrt <- sleuth_results(s_obj,test="reduced:full",test_type="lrt")
sleuth_diffex_lrt %>% arrange(qval)
```

### Wald
```{r}
s_obj <- sleuth_wt(s_obj,"ResponseR")
sleuth_diffex_wald <- sleuth_results(s_obj,test="ResponseR",test_type="wald")
sleuth_diffex_lrt %>% arrange(qval)
```
```{r}
plot_volcano(s_obj,test_type="wt",test="ResponseR",sig_level=0.05) +
  labs(title="Volcano Plot of Sleuth Identified Differentially Expressed Genes",
       x="log2FC",
        color="Q < 0.05")
```

# DESeq (Kallisto)
```{r}
txi <- tximport(
  file.path(samples_filt$kallisto_path,"abundance.h5"),
  type = "kallisto",
  tx2gene = select(
    t2g,
    TXNAME = ensembl_transcript_id_version,
    GENEID = external_gene_name,
  ),
  ignoreAfterBar = TRUE,
)
deseq_kallisto_data <- DESeqDataSetFromTximport(txi,samples_filt,~Response)

```

## QC
```{r}
deseq_kallisto_norm <- vst(deseq_kallisto_data)
meanSdPlot(assay(deseq_kallisto_norm),ranks=FALSE)
```


## PCA
```{r}
plotPCA(deseq_kallisto_norm,intgroup="Response")
```
## Difex
```{r}
deseq_kallisto_data <- DESeq(deseq_kallisto_data)
deseq_kallisto_lrt <- results(deseq_kallisto_data,name="Response_R_vs_NR",tidy=TRUE)
deseq_kallisto_lrt %>% 
  filter(padj < 0.05) %>%
  arrange(padj) %>%
  select(row,log2FoldChange,pvalue,padj) %>%
  left_join(select(t2g,ensembl_gene_id,external_gene_name),by=c("row"="ensembl_gene_id"))
```

# DESeq (FeatureCounts)
```{r}
fc_mat <- read_tsv("../work/input/GSE126044_counts.txt")
 fc_mat <- fc_mat[!grepl("^\\d+\\-",fc_mat$X1),] %>%
   column_to_rownames("X1") %>%
   select(one_of(samples_filt$`Patient ID`))
deseq_fc <- DESeqDataSetFromMatrix(countData=fc_mat,colData=samples_filt,design=~Response)
```

## QC
```{r}
deseq_fc_norm <- vst(deseq_fc)
meanSdPlot(assay(deseq_fc_norm),rank=FALSE)
```


## PCA
```{r}
plotPCA(deseq_fc_norm,intgroup="Response")
```

# Difex
```{r}
deseq_fc <- DESeq(deseq_fc)
deseq_fc_lrt <- results(deseq_fc,name="Response_R_vs_NR",tidy=TRUE)
deseq_fc_lrt %>% 
  filter(padj < 0.05) %>%
  arrange(padj) %>%
  select(row,log2FoldChange,pvalue,padj)
```

## counts_to_rpm, pca

fc_mat <- read_tsv("/Users/.../Documents/GSE126044_counts.txt")
tfc<- as.data.frame(t(fc_mat[,-1]))
colnames(tfc) <- fc_mat$X1
# Convert Kallisto counts to rpm
kalread<-cbind(kallisto_est_mapped, sleuth_rna_norm)
kalrpm<-setDT(kalread) [, lapply(.SD, function(x) (x * 1e6) / (kallisto_mapped_reads)),  by=.(kallisto_mapped_reads,sample)] %>% 
  column_to_rownames("sample")

# Convert star fc to rpm
#get df with est total reads for star
star_est_mapped<-data.frame(colSums(fc_mat[-1]), c("Dis_01", "Dis_02", "Dis_11", "Dis_12", "Dis_15", "Dis_04", "Dis_16",
                                      "Dis_17", "Dis_03", "Dis_07", "Dis_10", "Dis_18", "Dis_09","Dis_05", "Dis_06","Dis_08"))
colnames(star_est_mapped)<-c("star_est_mapped", "sample")
staread<-cbind(star_est_mapped, tfc)
starpm<-setDT(staread) [, lapply(.SD, function(x) (x * 1e6) / (star_est_mapped)),  by=.(star_est_mapped,sample)] %>%
  column_to_rownames("sample")

## scale pca with rpm
kal_rpm_pca <- prcomp(kalrpm[,-1],center=TRUE,scale.=TRUE)

starnorm_std <- scale(starpm[,-1])
#star counts include some zero, set scale/std apply to those !=0
star_rpm_pca <- prcomp(starnorm_std[ , which(apply(starnorm_std, 2, var) != 0)],center=TRUE)

## superimposed pca plots from the two sources
p1<-kal_rpm_pca$x[,1:2] %>% as.data.frame()
p2<-star_rpm_pca$x[,1:2] %>% as.data.frame()
ggplot()+geom_point(data=p1,aes(x=PC1,y=PC2, color='Kallisto')) + geom_point(data=p2,aes(x=PC1,y=PC2,color='STAR')) + scale_colour_manual(name="Dataset",values=c(Kallisto="blue", STAR="red"))


